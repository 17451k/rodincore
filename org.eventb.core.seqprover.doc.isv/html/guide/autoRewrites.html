<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <title>Automatic Rewriting Reasoners</title>
  </head>
  
  <body>
    <h1>Automatic Rewriting Reasoners</h1>
    <h2>Concepts</h2>

    <p>
      The reasoners of this type does not have any extra input (except the
      sequent) and automatically rewrites all the occurrences of certain
      formulas into other ones. An example of this is the rewriter which
      rewrites according to the following rules:
    </p>
    <ul>
      <li>⊤ ⇒ P == P
      <li>P ⇒ ⊤ == ⊤
      <li>⊥ ⇒ P == ⊤
      <li>P ⇒ ⊥ = ⊥
    </ul>

    <h2>Implementation</h2>
    Steps by steps:
    <ul>
    <li>Create a new plug-in project, e.g. <code>org.eventb.contributor.seqprover.arith</code>
    <li>Added dependency: <code>org.eventb.core.seqprover</code>.
    <li>Add an extension to the point <code>org.eventb.core.seqprover.reasoners</code>, e.g
	<p>
    <font color="#4444cc">
    <pre>
            class="org.eventb.core.seqprover.arith.ArithRewrites"
            id="org.eventb.core.seqprover.arithmetic"
            name="%arithRewritesName"
    </pre>
    </font>
    </p>
    <li>Implement the class: Click on the class attribute of the extension, a dialog will appear for
    new class wizard.
    <li>This class should extend the <code>import org.eventb.internal.core.seqprover.eventbExtensions.rewriters.AbstractAutoRewrites</code>.
      For the moment, the class is internal within the project and subjected to
      be changed. Clients can make a copy of this class to develop their own
      implementation.
    <p>An example is as follows:
      <font color="#4444cc">
    </p>
    <pre>
	import org.eventb.core.ast.IFormulaRewriter;
	import org.eventb.core.seqprover.SequentProver;

	public class ArithRewrites extends AbstractAutoRewrites {

		private static final IFormulaRewriter rewriter = new ArithRewriterImpl();

		public AutoRewrites() {
			super(rewriter, true);
		}

		public static String REASONER_ID = SequentProver.PLUGIN_ID
				+ ".autoRewrites";

		public String getReasonerID() {
			return REASONER_ID;
		}

		@Override
		protected String getDisplayName() {
			return "simplification rewrites";
		}
	}
    </pre>
  	</font>
    <p>
      The constructor of should call the super constructor method
      super(IFormulaRewriter, boolean) to specify the formula rewriter to use
      and the reasoner should hide the source of the rewritten hypothesis or
      not.  Clients need to implement two methods. The first one namely
      <code>getReasonerID()</code> return the string ID of this reasoner. This
      must be the same ID as declared in the XML file (do not forget the
      project name prefix).
    </p>
    <p>
      The second method is <code>getDisplayName()</code> which return the
      display name of the reasoner, which will be used for displaying in the
      UI.
    </p>
    <p>
      In order to implement the formula rewriter, clients are suggested to use Tom. 
      The instruction is as follows:
      <ul>
      <li>Create a file named "build-tom.xml" within your project. The best way to do
      this is to copy from <code>org.eventb.core.seqprover</code>, and modify this accordingly.
      <li>Right click on the name of your project and choose Properties.
      <li>Choose "Builders", then click on "New" and choose "Ant Build" and click OK. A 
      dialog will open for new builder wizard. 
      <li>At the "Main" tab:
      	<ul>
      	<li>Enter the name of the builder, e.g. Tom.
      	<li>Buildfile: "Browse Workspace" to your "build-tom.xml".
      	<li>Base Directory: "Variables" and choose "build_project".
      	</ul>
      <li>At the "Targets" tab:
      	<ul>
      	<li>Auto Build: Click "Set Targets" and choose "tom" from the list.
      	<li>During a "clean": Click "Set Targets" and choose "clean" (unchecked "tom").
      	</ul>
      </ul>
      You will come back to this builder later on.
      
    <li>Implementing the rules:
    	<ul>
    	<li>Create a file called ArithRewriterImpl.t (the name should be consistency with the step above).
    	<li>The content of the file should look like this</li>
<font color="#4444cc">
<pre>
package org.eventb.core.seqprover.arith;

import java.util.ArrayList;
import java.util.Collection;
import java.math.BigInteger;

import org.eventb.core.ast.AssociativeExpression;
import org.eventb.core.ast.AssociativePredicate;
import org.eventb.core.ast.AtomicExpression;
import org.eventb.core.ast.BinaryExpression;
import org.eventb.core.ast.BinaryPredicate;
import org.eventb.core.ast.BoolExpression;
import org.eventb.core.ast.BoundIdentDecl;
import org.eventb.core.ast.BoundIdentifier;
import org.eventb.core.ast.DefaultRewriter;
import org.eventb.core.ast.Expression;
import org.eventb.core.ast.Formula;
import org.eventb.core.ast.FormulaFactory;
import org.eventb.core.ast.FreeIdentifier;
import org.eventb.core.ast.Identifier;
import org.eventb.core.ast.IntegerLiteral;
import org.eventb.core.ast.LiteralPredicate;
import org.eventb.core.ast.Predicate;
import org.eventb.core.ast.QuantifiedExpression;
import org.eventb.core.ast.QuantifiedPredicate;
import org.eventb.core.ast.RelationalPredicate;
import org.eventb.core.ast.SetExtension;
import org.eventb.core.ast.SimplePredicate;
import org.eventb.core.ast.UnaryExpression;
import org.eventb.core.ast.UnaryPredicate;
import org.eventb.core.seqprover.eventbExtensions.Lib;

@SuppressWarnings("unused")
public class ArithRewriterImpl extends DefaultRewriter {

	public ArithRewriterImpl() {
		super(true, FormulaFactory.getDefault());
	}
	
	...

}
</font>
</pre>
		</ul>
      See example of
      <code>org.eventb.internal.core.seqprover.eventbExtensions.rewriters.AutoRewriterImpl.t</code>
      which implement most of the automatic rewriting rules as in the User
      Manual (reference needed here) supplied with the Rodin platform.
   </p>

    
    </ul> 
    
    

    <h2>Testing</h2>
    The abstract automatic rewriting reasoners has been tested, so clients only
    need to test if the reasoner has been declared correctly (testing the
    reasoner ID), and the formula rewriter used for this reasoner has been
    implemented correctly.
    <h3>Testing the reasoner ID</h3>
    <p>
      This test based on the abstract class
      <code>org.eventb.core.seqprover.rewriterTests.AbstractAutomaticReasonerTests</code>. An example is as follows.
    </p>
    <pre>
import org.eventb.core.seqprover.SequentProver;

public class ArithRewriterReasonerTests extends AbstractAutomaticReasonerTests {

	@Override
	protected SuccessfulTest[] getSuccessfulTests() {
		// No need to test this. This should be guaranteed by testing the
		// abstract automatic rewrite reasoner and the formula rewriter itself.
		return new SuccessfulTest [] {
		};
	}

	@Override
	protected String[] getUnsuccessfulTests() {
		// No need to test this. This should be guaranteed by testing the
		// abstract automatic rewrite reasoner and the formula rewriter itself.
		return new String [] {
		};	
	}

	@Override
	public String getReasonerID() {
		return "org.eventb.core.seqprover.arithmetic";
	}

}
    </pre>
    <p>
      In this test, clients only need to provide the reasoner ID under test.
    </p>

    <h3>Testing the formula rewriter</h3>
    <p>
      This test based on the abstract class
      <code>org.eventb.core.seqprover.rewriterTests.AbstractFormulaRewriterTests</code>. An example is as follows.
    </p>
    <pre>
import org.eventb.internal.core.seqprover.eventbExtensions.rewriters.AutoRewriterImpl;
import org.junit.Test;

public class ArithFormulaRewriterTests extends AbstractFormulaRewriterTests {
	
	// The automatic rewriter for testing.
	private static final IFormulaRewriter rewriter = new ArithRewriterImpl();
	
	/**
	 * Constructor.
	 * <p>
	 * Create an abstract formula rewriter test with the input is the automatic
	 * rewriter.
	 */
	public ArithFormulaRewriterTests() {
		super(rewriter);
	}

	/**
	 * Tests for rewriting conjunctions.
	 */
	@Test
	public void testRewrite() {
                // Test rewriting predicate
		predicateTest("⊥", "x = 1 ∧ ⊥");
                // Test rewriting expression
		expressionTest("1", "card({x + 1})");
        }

}
    </pre>
    <p>
      More instructions about how to use the method <code>predicateTest</code>
      and <code>expressionTest</code> (along with some other utility methods)
      can be found in
      <code>org.eventb.core.seqprover.rewriterTests.AbstractFormulaRewriterTests</code> class.      
    </p>
</body>
</html>
